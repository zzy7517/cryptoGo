version: '3.8'

services:
  # 后端服务
  backend:
    build:
      context: ..
      dockerfile: docker/backend.Dockerfile
    container_name: cryptogo-backend
    ports:
      - "9527:9527"
    volumes:
      # 挂载数据目录，持久化 SQLite 数据库
      - ../backend/data:/app/data
    environment:
      # 数据库配置 - 使用 SQLite（本地文件数据库）
      - DATABASE_URL=${DATABASE_URL:-sqlite:///./data/trading.db}

      # 币安 API 配置
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
      - BINANCE_TESTNET=${BINANCE_TESTNET:-true}

      # AI 配置
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - OPENAI_API_BASE=${OPENAI_API_BASE}

      # 其他配置
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9527/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # 前端服务
  frontend:
    build:
      context: ..
      dockerfile: docker/frontend.Dockerfile
    container_name: cryptogo-frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://backend:9527}
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped

networks:
  default:
    name: cryptogo-network
